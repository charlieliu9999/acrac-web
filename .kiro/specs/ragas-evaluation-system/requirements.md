# RAGAS评测系统需求文档

## 项目概述

基于前期深入分析，重构ACRAC医疗影像推荐系统的RAGAS评测功能，解决当前评测指标异常问题，构建一个高效、准确、易用的评测系统。

## 核心问题

当前系统存在的关键问题：
- Answer Relevancy评分为0.000（LLM输出解析失败）
- Faithfulness评分偏低0.155（提示工程缺陷）
- 代码版本混乱，存在多个重复实现
- 数据转换格式不统一
- 缺少统一的配置管理

## 需求列表

### 需求1：核心评测引擎重构

**用户故事：** 作为系统管理员，我希望有一个稳定可靠的RAGAS评测引擎，能够准确评估RAG系统的四个核心指标。

#### 验收标准

1. WHEN 系统启动时 THEN 评测引擎应该能够成功初始化并加载配置
2. WHEN 提供标准RAGAS数据格式时 THEN 系统应该返回四个评测指标的准确分数
3. WHEN Answer Relevancy评测时 THEN 系统应该能够正确解析LLM输出并返回0.1-1.0范围内的分数
4. WHEN Faithfulness评测时 THEN 系统应该能够检测答案与上下文的忠实度，目标分数>0.4
5. WHEN Context Precision评测时 THEN 系统应该能够评估检索上下文的精确度，保持当前0.8+水平
6. WHEN Context Recall评测时 THEN 系统应该能够评估上下文覆盖度，目标分数>0.6

### 需求2：数据转换与验证

**用户故事：** 作为开发人员，我希望有一个标准化的数据转换器，能够将RAG推理结果准确转换为RAGAS评测格式。

#### 验收标准

1. WHEN 输入RAG推理结果时 THEN 系统应该提取结构化的答案内容
2. WHEN 处理上下文数据时 THEN 系统应该过滤重复内容并限制长度在200字符以内
3. WHEN ground_truth为空时 THEN 系统应该基于临床查询智能推断基础答案
4. WHEN 数据验证失败时 THEN 系统应该提供详细的错误信息和修复建议
5. IF 上下文数量超过5个 THEN 系统应该选择最相关的5个上下文

### 需求3：统一API接口

**用户故事：** 作为前端开发者，我希望有简洁统一的API接口来调用RAGAS评测功能。

#### 验收标准

1. WHEN 调用评测API时 THEN 系统应该支持同步和异步两种模式
2. WHEN 批量评测时 THEN 系统应该提供实时进度反馈
3. WHEN 评测失败时 THEN 系统应该返回详细的错误信息和重试建议
4. WHEN 请求健康检查时 THEN 系统应该返回所有依赖组件的状态
5. IF 评测数据格式错误 THEN 系统应该返回400状态码和具体的格式要求

### 需求4：前端评测界面优化（四阶段流程）

**用户故事：** 作为医疗专家，我希望有一个直观的四阶段评测界面，能够完整地管理从数据上传到评测结果的全流程。

#### 验收标准

**阶段1：数据上传与预览**
1. WHEN 上传包含question和ground_truth的Excel/CSV文件时 THEN 系统应该实时解析并显示数据预览表格
2. WHEN 数据格式验证时 THEN 系统应该检查必需字段（question_id, clinical_query, ground_truth）并显示验证结果
3. WHEN 预览数据时 THEN 用户应该能够勾选特定行进行批量推理
4. IF 数据格式错误 THEN 系统应该显示具体的错误位置和修复建议

**阶段2：批量推理与中间数据记录**
5. WHEN 点击"开始批量推理"时 THEN 系统应该调用RAG-LLM API并保存完整的推理中间数据
6. WHEN 推理进行中时 THEN 界面应该显示实时进度条和当前处理的案例信息
7. WHEN 推理完成时 THEN 系统应该显示推理结果列表，包含推荐结果与ground_truth的对比
8. WHEN 查看推理详情时 THEN 用户应该能够查看完整的中间数据（scenarios、contexts、llm_recommendations、trace信息）

**阶段3：推理结果管理与选择**
9. WHEN 推理完成后 THEN 系统应该显示推理结果表格，支持按成功/失败状态筛选
10. WHEN 查看推理详情时 THEN 系统应该结构化展示LLM推荐、检索场景、上下文信息、模型参数等
11. WHEN 选择推理结果时 THEN 用户应该能够勾选特定的推理记录进行RAGAS评测
12. WHEN 数据处理预览时 THEN 系统应该显示转换为RAGAS格式后的数据预览（question、answer、contexts、ground_truth）

**阶段4：RAGAS评测执行与结果展示**
13. WHEN 点击"开始RAGAS评测"时 THEN 系统应该显示基于推理数据提取的评测输入数据预览
14. WHEN RAGAS评测进行中时 THEN 界面应该显示评测进度、当前样本信息和预计完成时间
15. WHEN 评测完成时 THEN 系统应该展示四个指标的详细分数和可视化图表
16. WHEN 查看评测结果时 THEN 用户应该能够查看每个样本的详细评分和评测过程
17. WHEN 导出结果时 THEN 系统应该支持导出完整的评测报告（包含原始数据、推理结果、评测分数）

### 需求5：配置管理与模型适配

**用户故事：** 作为系统配置员，我希望能够灵活配置评测模型和参数，适应不同的评测场景。

#### 验收标准

1. WHEN 修改评测模型配置时 THEN 系统应该从model_contexts.json的evaluation上下文读取配置
2. WHEN 切换LLM模型时 THEN 系统应该自动适配不同模型的输出格式解析
3. WHEN 调整评测参数时 THEN 系统应该支持温度、top_p等参数的动态配置
4. WHEN 配置验证失败时 THEN 系统应该提供详细的配置错误信息
5. IF 模型API不可用 THEN 系统应该自动降级到备用模型或离线模式

### 需求6：性能与监控

**用户故事：** 作为运维人员，我希望系统具有良好的性能表现和完善的监控能力。

#### 验收标准

1. WHEN 单个样本评测时 THEN 响应时间应该在30秒以内
2. WHEN 批量评测时 THEN 系统应该支持并发处理，吞吐量>2样本/分钟
3. WHEN 系统负载过高时 THEN 应该自动限流并返回503状态码
4. WHEN 出现异常时 THEN 系统应该记录详细日志并发送告警
5. WHEN 内存使用超过80%时 THEN 系统应该自动清理缓存

### 需求7：测试与质量保证

**用户故事：** 作为质量保证工程师，我希望有完善的测试体系确保系统的可靠性。

#### 验收标准

1. WHEN 运行单元测试时 THEN 代码覆盖率应该达到90%以上
2. WHEN 执行集成测试时 THEN 所有API接口应该返回预期结果
3. WHEN 进行性能测试时 THEN 系统应该在100并发下稳定运行
4. WHEN 模拟异常场景时 THEN 系统应该优雅降级而不是崩溃
5. WHEN 回归测试时 THEN 核心评测指标的准确性应该保持稳定

## 技术约束

1. **兼容性要求**：必须与现有的FastAPI后端和React前端架构兼容
2. **模型支持**：支持SiliconFlow、OpenAI等多种LLM提供商
3. **数据格式**：兼容现有的Excel上传和JSON数据格式
4. **性能要求**：单次评测响应时间<30秒，批量评测支持异步处理
5. **安全要求**：API密钥安全存储，数据传输加密

## 成功标准

### 功能指标
- Answer Relevancy评分从0.000提升到0.6+
- Faithfulness评分从0.155提升到0.4+
- Context Precision保持0.8+水平
- Context Recall从0.583提升到0.6+

### 质量指标
- 代码重复度降低80%
- API响应时间减少50%
- 错误率降低到5%以下
- 用户满意度达到90%+

### 维护指标
- 新功能开发效率提升50%
- 问题定位时间减少60%
- 代码审查通过率达到95%+

## 风险评估

### 高风险
- LLM模型输出格式变化导致解析失败
- 大批量评测时的内存溢出问题

### 中风险
- 第三方API服务不稳定
- 数据格式兼容性问题

### 低风险
- 前端界面兼容性
- 配置文件格式变更

## 验收测试计划

1. **功能测试**：验证所有用户故事的验收标准
2. **性能测试**：验证响应时间和并发处理能力
3. **兼容性测试**：验证与现有系统的集成
4. **安全测试**：验证API安全和数据保护
5. **用户验收测试**：医疗专家实际使用场景验证