# ACRAC 医疗影像推荐系统 · 系统性优化实施方案（按优先级）

本方案严格遵循以下原则：
- 系统性、通用性优先，禁止为“抬分”而进行指标层面的代码作弊
- 分阶段实施，每阶段完成后进行端到端验证（功能、性能、兼容）
- 保持向后兼容，所有重大变更具备开关与回滚能力

## 目录
- 概述与目标
- 优先级1：模型配置系统全面重构（最高）
- 优先级2：RAG+LLM 推理流程深度优化（高）
- 优先级3：RAGAS 评测系统通用化改进（中）
- 优先级4：API 架构优化与治理（低）
- 全局：测试与回滚、监控与告警、风险与应对
- 里程碑与验收标准（M1–M8 汇总）

---
## 概述与目标
- 评测可信度与一致性：提升 RAGAS 四项核心指标的可解释性与稳定性（尤其 answer_relevancy、context_recall）
- 模型可用性与治理：统一多模型源的配置、测试、灰度与降级能力
- 推理性能：在不牺牲质量前提下，将主路径 P90 响应时间压至 < 3s
- 接口治理：端点收敛与统一规范，降低维护成本

---
## 优先级1：模型配置系统全面重构（最高）
### 1. 架构设计
- Provider 适配层：Ollama（本地）、SiliconFlow、OpenAI、DashScope（通义千问）
  - 能力：连通性测试、模型列表、向量维度/速率/配额查询
- Model Registry：embedding/llm/rerank 独立配置并可组合为运行时 Profile
- Runtime 切换：基于版本号与读写锁的原子热更新；支持 A/B 流量灰度
- 强制准入测试：连接性、性能（延迟/吞吐）、基础准确性（金标小集）
- 监控与自动降级：指标超阈值→自动切回备用 Profile，记录审计日志

### 2. 技术选型
- 后端：FastAPI + 统一 ProviderClient（requests/httpx），Redis 记录健康状态
- 前端：ModelConfigNew + SystemStatusCard + ProviderTabs + ModelProviderCard
- 数据：Profile 持久化 DB（或配置表），运行时驻留内存（带版本）
- 监控：prometheus-client（按 provider/model 打标签）

### 3. 接口与数据结构（建议）
- GET /api/v1/admin/system/status：API/DB/Embedding/LLM 状态（绿/红+原因）
- POST /api/v1/admin/models/providers/test：连通性/鉴权/耗时
- GET /api/v1/admin/models/compatibility/check：库表维度 vs 目标维度
- POST /api/v1/admin/models/registry/apply：应用 Profile（支持灰度比例）
- GET /api/v1/admin/models/registry/active：查询当前生效 Profile

### 4. 实施步骤（M1–M2）
- M1（1 周）：状态总览与 Provider 连通测试、维度兼容检查（只读）
- M2（1 周）：Model Registry + 原子热更新（10% 灰度）、准入测试基线、Prometheus 指标

### 5. 验收标准
- 切换 Profile 0 宕机、0 解析错误；失败阈值自动回退；指标可见
- 仅当准入测试通过才允许“发布”按钮可点击

### 6. 测试与回滚
- 单元：Provider 适配器、ModelRuntime 切换
- 集成：/providers/test 返回正确；/registry/apply 生效与 active 可见
- E2E：从前端切换 Profile 后，日志证实请求已命中新模型
- 回滚：保留上一版本 Profile，阈值触发或人工一键回退

---
## 优先级2：RAG+LLM 推理流程深度优化（高）
### 1. 架构优化点
- 向量检索：HNSW（或 IVF）评估与参数调优；向量维度与 embedding 模型一致性
- 多级检索：粗排（近似）→ 精排（精确相似度）→ 重排（Cross-Encoder，可 bge-reranker）
- 并行化：向量化/缓存检查/模型预热并发；检索与重排并行；重排结束即触发 LLM
- 智能缓存：L1（LRU 内存）+ L2（Redis）+ L3（DB）；TTL 与一致性策略
- Prompt/上下文：证据精摘、严格 JSON 输出约束，减少冗余与解析成本

### 2. 技术选型
- pgvector + HNSW（m/ef_construction/ef_search）；或 IVF + probes
- 并发：asyncio.gather + 限流器
- 缓存：cachetools（LRU）+ redis-py；键策略=语义 query+Profile+topK
- 监控：/metrics 输出 P50/P90/P99、命中率、错误率

### 3. 实施步骤（M3–M4）
- M3（1 周）：OptimizedInferenceEngine 并行骨架 + L1 缓存；特性开关
- M4（1 周）：HNSW/IVF 索引上线 + L2 Redis 缓存 + /metrics

### 4. 目标与验收
- 50 条固定测集：P90 < 3.0s；准确性不低于现状；缓存命中率 ≥ 60%
- 可一键切回旧引擎；两套索引并存以防回退成本

### 5. 测试与回滚
- 单元：缓存键与失效、并发容错
- 集成：索引 explain analyze 对比
- E2E：同一测集多轮基准曲线对比
- 回滚：环境变量开关，索引保留双栈

---
## 优先级3：RAGAS 评测系统通用化改进（中）
### 1. 评测框架
- LLM-as-Judge：以指南检索片段为“裁判证据”，判定术语等价、临床适宜性、推荐合理性
- 模板与 Schema：医疗领域专用 Prompt + 严格 JSON Schema 输出；可与传统 RAGAS 四项联合展示
- 证据与可解释性：输出引用依据与改进建议

### 2. 数据与持续验证
- 小型金标集（20–50 条）+ 周期回归；保留 trace 可复现

### 3. 实施步骤（M5–M6）
- M5（2 周）：评测模板与裁判引擎；前端展示裁决依据；JSON 合法率 > 99%
- M6（2 周）：批量评测 + 可视化（分布/趋势/TopN）；多模型对比报告

### 4. 验收
- 能明确解释“为何低分、如何改进”；与传统四项指标具备合理相关性

### 5. 测试与回滚
- 单元：模板渲染与 JSON 校验
- 集成：裁判检索 + 输出一致性
- 回滚：关闭裁判评测路径，仅保留传统四项

---
## 优先级4：API 架构优化与治理（低）
### 1. 治理策略
- 采集：统计端点命中率（网关日志、前端拦截器）
- 收敛：保留/合并/废弃（兼容转发 + Deprecation Header + 文档标注）
- 统一响应语义：code/message/data + traceId；统一错误码
- 文档：OpenAPI 3.0 自动化 + 示例 + 错误场景

### 2. 实施步骤（M7–M8）
- M7（1 周）：第一轮收敛，端点数 ≤ 45；Swagger 更新
- M8（1 周）：第二轮收敛提案（目标 ~30）；统一响应规范落地

### 3. 验收
- 0 线上兼容事故；前端调用全部迁移；文档覆盖 > 95%

---
## 全局：测试与回滚、监控与告警、风险与应对
### 测试策略
- 单元/集成/E2E 分层；固定样本集用于性能与准确性基线
- CI 中加入最小测集的自动回归与阈值守护

### 回滚机制
- 所有重大改造具备开关；Profile 版本链可回退；双栈索引避免大回滚成本

### 监控告警
- 指标：请求时延（P50/P90/P99）、错误率、缓存命中率、模型调用成功率/时延/成本
- 告警：阈值触发降级或回退，并记录审计

### 风险与应对
- 向量维度迁移风险 → 仅做兼容检查与迁移预演；正式迁移前全量备份
- 模型服务不稳定 → 多 Provider 冗余 + 自动降级
- 并行与缓存引入一致性问题 → 小流量灰度 + 指标守护 + 一键回退

---
## 里程碑与验收标准（汇总）
- M1：状态/连通/兼容检查（1 周）→ 所有 Provider 连通成功；不兼容维度可识别
- M2：Registry+热更新+准入+指标（1 周）→ 切换 0 宕机；仅准入通过可发布
- M3：并行骨架+L1 缓存（1 周）→ P90 < 3.5s，不降质
- M4：索引+L2 缓存+/metrics（1 周）→ P90 < 3.0s；命中率 ≥ 60%
- M5：裁判评测与依据（2 周）→ JSON 合法率 > 99%，可解释
- M6：批量与可视化（2 周）→ 1000+ 样本稳定输出报告
- M7：API 第一轮收敛（1 周）→ ≤ 45 端点，兼容层与文档齐全
- M8：API 第二轮与规范（1 周）→ ~30 端点，统一响应语义

